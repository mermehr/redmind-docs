# Windows & Active Directory Persistence

## Scheduled Task

**Create via `schtasks`:**

```powershell
# Create a task that runs at system startup
schtasks /Create /SC ONSTART /TN "PersistTest" /TR "powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\Temp\persist.ps1" /RL HIGHEST /F

# Create a task that runs at logon for the current user (no admin required)
schtasks /Create /SC ONLOGON /TN "UserMonitor" /TR "powershell.exe -NoProfile -File C:\Temp\user_monitor.ps1" /F
```

**PowerShell (Register-ScheduledTask):**

```powershell
$action = New-ScheduledTaskAction -Execute 'PowerShell.exe' -Argument '-NoProfile -WindowStyle Hidden -File C:\Temp\persist.ps1'
$trigger = New-ScheduledTaskTrigger -AtStartup
Register-ScheduledTask -TaskName 'PersistTest' -Action $action -Trigger $trigger -RunLevel Highest
```

------

## Windows Service — always-on behavior

**Create with `sc`:**

```cmd
sc create MyService binPath= "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -File C:\Temp\persist.ps1" start= auto
sc start MyService
```

**Use `nssm` for easier service wrapping:**

```cmd
# (Copy nssm.exe to the host first)
nssm install MyService "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" "-File C:\Temp\persist.ps1"
nssm start MyService
```

------

## Registry Run keys & Startup folder (per-user, low-priv)

**Registry (HKCU):**

```powershell
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "PersistTest" -Value "C:\Temp\myprogram.exe"
```

**Startup folder (per-user):**

```powershell
Copy-Item C:\Temp\shortcut.lnk "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup\"
```

------

## Scheduled PowerShell Jobs (Register-ScheduledJob)

PowerShell native approach for periodic/startup jobs:

```powershell
Register-ScheduledJob -Name PersistJob -FilePath C:\Temp\persist.ps1 -Trigger (New-JobTrigger -AtStartup)
```

------

## WinRM / PowerShell Remoting — reattach & manage

If WinRM/PowerShell Remoting is enabled and allowed:

```powershell
# Enter an interactive session
Enter-PSSession -ComputerName TARGET -Credential (Get-Credential)

# Create a persistent session to reuse
$s = New-PSSession -ComputerName TARGET -Credential (Get-Credential)
Invoke-Command -Session $s -ScriptBlock { Get-Service }
```

------

## Monitoring & Cleanup

**List scheduled tasks:**

```powershell
schtasks /Query /FO LIST /V
# or
Get-ScheduledTask | Format-Table TaskName,State,Principal
```

**List services:**

```powershell
Get-Service | Where-Object { $_.Status -eq 'Running' -or $_.StartType -eq 'Automatic' }
```

**Check Run keys:**

```powershell
Get-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"
Get-ItemProperty -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run"
```

**Startup folders:**

```powershell
Get-ChildItem "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup"
Get-ChildItem "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
```

**Deep inspect with Sysinternals:**

- `Autoruns.exe` (recommended) — shows drivers, services, scheduled tasks, Run keys, and more.

**GPO checks:**

```cmd
gpresult /R
```

**Example:**

```powershell
# Delete scheduled task
Unregister-ScheduledTask -TaskName 'PersistTest' -Confirm:$false
# Stop & delete service
sc stop MyService
sc delete MyService
# Remove Run key
Remove-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "PersistTest"
```
