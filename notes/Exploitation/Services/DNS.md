---
title: "Attacking Common Services — DNS"
tags: [attacking-common-services, dns, enumeration, zone-transfer, subdomain-takeover, spoofing]
tools: [dig, host, nslookup, nmap, fierce, subfinder, amass, massdns, subbrute, crtsh, can-i-take-over-xyz, bettercap, ettercap, responder]
---

# DNS

## Summary
DNS is a high-value information source during reconnaissance. Misconfigurations (zone transfers, stale records, subdomain records pointing to deprovisioned services) can lead to discovery of hosts, credentials, or subdomain takeover. Local DNS spoofing in a man-in-the-middle (MITM) environment can allow credential capture or traffic interception.

## DNS Zone Transfer
Zone transfers (AXFR) expose the entire DNS zone if misconfigured. Always try a targeted AXFR against authoritative name servers first.

### Quick `dig` AXFR check
```bash
# Query the authoritative NS for AXFR
dig AXFR @ns1.example.com example.com
```

If this returns a complete zone file, save it to disk and greppable it for hosts, MX records, TXT records, etc.

### Practical notes
- Check all authoritative nameservers returned by `dig +short ns example.com` — some admins open AXFR on a subset.
- If AXFR fails, try `dig ANY` and `dig axfr` against each NS; some servers restrict AXFR to specific IPs.
- Look for hostnames, MX records, TXT (possible secrets), SRV records, and delegated subdomains.

---

## Enumerating Nameservers & Subdomains
Prioritize passive sources first (crt.sh, Certificate Transparency, public resolvers) then follow up with active discovery.

### Passive discovery (fast wins)
- crt.sh: search for certificates issued for the domain and gather subdomains.
- OSINT: GitHub, public S3 buckets, archives, and public repo searches.

### `fierce` — combined NS discovery and AXFR checks
```bash
fierce --domain example.com
```
- Good for quick sweeps; review its output for authoritative NS and potential AXFR candidates.

### `subfinder` (passive → active)
```bash
./subfinder -d example.com -v
```
- Fast passive/active aggregator. Follow-up with `massdns` or `amass` for bulk resolution.

### `subbrute` — brute force approach
```bash
git clone https://github.com/TheRook/subbrute.git
cd subbrute
# provide resolvers and a wordlist of subdomains
echo "ns1.example.com" > ./resolvers.txt
./subbrute.py example.com -s ./names.txt -r ./resolvers.txt
```
- Use only when passive enumeration is exhausted or when you suspect many low-value subdomains.

---

## Subdomain Takeover
Subdomain takeover occurs when DNS records point to an external service (e.g., GitHub Pages, S3, Heroku) but the resource has been deprovisioned — an attacker can claim it.

- Use `can-i-take-over-xyz` to automatically test common provider patterns.
- Manual checks: find CNAMEs pointing to third-party hosts, then test whether the target is unclaimed.
- Check for 404s or provider-specific errors that indicate an unattached resource.

Example:
```bash
# run can-i-take-over-xyz scan
# (install per repo instructions)
python3 can-i-take-over-xyz.py -d example.com
```

---

## DNS Spoofing / MITM
Local DNS spoofing can be highly effective in internal network engagements where you can perform ARP spoofing or control a DNS resolver.

### Bettercap / Ettercap notes
- Bettercap: modern and scriptable; supports DNS spoofing and HTTP/HTTPS manipulation (certificate pinning will limit effectiveness).
- Ettercap: simpler, good for quick DNS poisoning on legacy networks.

```bash
# basic bettercap DNS spoof example (requires root and interface up)
# set the domain to spoof and the fake IP
bettercap -I eth0 --proxy --proxy-https --dns --dns.spoof example.com=10.0.0.5
```

Practical cautions:
- HTTPS and HSTS make straightforward credential harvesting harder; leverage downgrade attacks or target non-HTTPS endpoints.
- On modern networks certificate pinning / HSTS will cause browser errors — use social engineering or target services that still use HTTP.

---

## Quick Commands / Cheatsheet
- Enumerate NS and try AXFR:
```bash
dig +short ns example.com | xargs -n1 -I{} dig AXFR @{} example.com
```
- Passive subdomain discovery via crt.sh (quick curl):
```bash
curl -s "https://crt.sh/?q=%25.example.com&output=json" | jq -r '.[].name_value' | sed 's/\*\.//g' | sort -u
```
- Resolve discovered subdomains in bulk (massdns):
```bash
massdns -r resolvers.txt -o S -w results.txt subdomains.txt
```

---

## Notes
- Always query all authoritative nameservers — AXFR may be open on only one.
- Certificate Transparency (crt.sh) often reveals subdomains missed by DNS brute-force.
- Watch for TTLs and cached records — changes may take time to propagate.
- Subdomain takeover checks should be conservative: do not claim targets or register resources during a test unless explicitly allowed by scope.
- Document every step and save raw outputs (dig, fierce, subfinder, massdns), they can be invaluable for post-engagement reporting.

---

## Next Steps (if escalation required)
- Correlate discovered subdomains with open ports (nmap) and web endpoints for further exploitation.
- Check MX/TXT records for exposed credentials or mail relays.
- Look for internal SRV records that hint at backend services (ldap, kerberos, etc.).

---

## References
- can-i-take-over-xyz — https://github.com/EdOverflow/can-i-take-over-xyz
- fierce — https://github.com/mschwager/fierce
- subfinder — https://github.com/projectdiscovery/subfinder
- subbrute — https://github.com/TheRook/subbrute
